#!/bin/bash

set -e

RSETUP_INTERACTIVE=0

source /lib/rsetup/utils.sh
source /lib/rsetup/block_helpers.sh

_first-boot() {
    if ! ls /etc/ssh/ssh_host_* >/dev/null 2>&1
    then
        # Regenerate SSH host key
        dpkg-reconfigure -f noninteractive openssh-server
    fi

    local ROOT_DEV=$(_get_root_dev)
    local FILESYSTEM=$(blkid -s TYPE -o value $ROOT_DEV)
    local PART_ENTRY_NUMBER=$(udevadm info --query=property --name=$ROOT_DEV | grep '^ID_PART_ENTRY_NUMBER=' | cut -d'=' -f2)
    local PART_TABLE_TYPE=$(udevadm info --query=property --name=$ROOT_DEV | grep '^ID_PART_TABLE_TYPE=' | cut -d'=' -f2)
    local BLOCK_DEV=$(_get_block_dev)

    # Fix GPT second partition table (should be at the end of the block device)
    if [[ $PART_TABLE_TYPE == "gpt" ]]
    then
        sgdisk -e $BLOCK_DEV
        partprobe
    fi

    # Resize our root partition
    cat << EOF | parted ---pretend-input-tty $BLOCK_DEV
resizepart ${PART_ENTRY_NUMBER} 
yes
100%
EOF
    partprobe
    case "$FILESYSTEM" in
        ext4)
            resize2fs $ROOT_DEV
            ;;
        btrfs)
            btrfs filesystem resize max /
            ;;
        *)
            echo Unknown filesystem. >&2
            ;;
    esac

    # Disable ourselves
    systemctl disable rsetup-first-boot.service
}

_create-systemconf() {
    cat << EOF >/boot/.radxa
#
# DO NOT EDIT THIS FILE
#
# Reserved for Radxa internal use to ensure
# proper functionality of the system
#

rootuuid=$(blkid --output value --match-tag UUID $(_get_root_dev))
EOF
}

update-bootloader() {
    _parameter_count_check 1 "$@"
    _assert_f "/usr/lib/u-boot-$1/setup.sh"

    local DEVICE=$(_get_block_dev)

    "/usr/lib/u-boot-$1/setup.sh" update_bootcmd
    "/usr/lib/u-boot-$1/setup.sh" update_bootloader $DEVICE
}

if (( $# == 0 )) || [[ $1 == main ]]
then
    main
else
    if [[ $(type -t $1) == function ]]
    then
        "$@"
    else
        echo $1 is not a valid function.
    fi
fi
